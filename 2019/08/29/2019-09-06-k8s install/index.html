<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kubernetes install in kubeadm | 網路技術學習過程</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">網路技術學習過程</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>kubernetes install in kubeadm</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2019-08-29</div><div class="post-tags"><a class="post-tag-link" href="/tags/kubeadm/">kubeadm</a>/<a class="post-tag-link" href="/tags/kubernetes/">kubernetes</a></div></div></div><article><div class="container post"><p>大概可以分成5大步驟，<br>安裝的環境是virtualbox + ubuntu 16.04</p>
<h2 id="若透過ubuntu安裝的，記得要先去-etc-resolv-conf的dns改掉，否則在kubeadm-init時dns會有問題，但從ubuntu-12-0版後-etc-resolv-conf每次重開機就會自動改回去，所以解法為"><a href="#若透過ubuntu安裝的，記得要先去-etc-resolv-conf的dns改掉，否則在kubeadm-init時dns會有問題，但從ubuntu-12-0版後-etc-resolv-conf每次重開機就會自動改回去，所以解法為" class="headerlink" title="若透過ubuntu安裝的，記得要先去/etc/resolv.conf的dns改掉，否則在kubeadm init時dns會有問題，但從ubuntu 12.0版後/etc/resolv.conf每次重開機就會自動改回去，所以解法為"></a>若透過ubuntu安裝的，記得要先去/etc/resolv.conf的dns改掉，否則在kubeadm init時dns會有問題，但從ubuntu 12.0版後/etc/resolv.conf每次重開機就會自動改回去，所以解法為</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/network/interfaces</span><br><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></table></figure>

<p>以三個VM來代表三台node，分別為一台Master及二台Worker<br>Master node透過kube-apiserver與Worker node的kubelet做溝通<br>其中第1、2步驟是三台VM都要做，而步驟3、4是Master VM要做，步驟5是兩台Worker VM要做的</p>
<h2 id="1-首先要確保三台VM都有建好docker環境，這邊要注意一點是在建docker環境時不要見到最新的docker-version，因為k8s沒有相容最新版本的docker"><a href="#1-首先要確保三台VM都有建好docker環境，這邊要注意一點是在建docker環境時不要見到最新的docker-version，因為k8s沒有相容最新版本的docker" class="headerlink" title="1. 首先要確保三台VM都有建好docker環境，這邊要注意一點是在建docker環境時不要見到最新的docker version，因為k8s沒有相容最新版本的docker"></a>1. 首先要確保三台VM都有建好docker環境，這邊要注意一點是在建docker環境時不要見到最新的docker version，因為k8s沒有相容最新版本的docker</h2><pre><code>- 因為k8s的prerequisite有要求三個node要有不同的hostname, mac及uuid，所以三台VM可以更改各自的hostname
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hostname</span><br><span class="line">vi /etc/hosts</span><br></pre></td></tr></table></figure>

- 要注意的地方是三台VM除了有能上網的網卡之外，最好在三台VM上各自建一個static ip的介面，作為三台VM上之溝通，可以在ubuntu的/etc/network/interfaces裡更改ip
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auto enp0s8</span><br><span class="line">iface enp0s8 inet static</span><br><span class="line">      address 192.168.1.10</span><br><span class="line">      netmask 255.255.255.0</span><br></pre></td></tr></table></figure>

- 關掉每台VM的swap功能
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#swapoff -a</span><br><span class="line">#vi /etc/fstab 中將swap那行的uuid註解掉</span><br></pre></td></tr></table></figure>

- 安裝docker部分可以參考docker官網 https://docs.docker.com/install/linux/docker-ce/ubuntu/
但到最後一步時要安裝符合k8s的版本時，不要直接照打，改成
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-ce=&lt;版本名稱17.03....&gt;</span><br></pre></td></tr></table></figure>

可以打apt-cache madison docker-ce看目前的docker cache版本有哪些
我想到我之前在安裝SEBA的時候就是安裝到最新的docker版本，所以在RUN SEBA就覺得怪怪的，但那時候對k8s還不熟</code></pre><h2 id="2-在三台VM安裝kubeadm、kubectl及kubelet，kubeadm本身套件沒有包刮kubelet及kubectl，所以這三個都要安裝在三台VM上"><a href="#2-在三台VM安裝kubeadm、kubectl及kubelet，kubeadm本身套件沒有包刮kubelet及kubectl，所以這三個都要安裝在三台VM上" class="headerlink" title="2. 在三台VM安裝kubeadm、kubectl及kubelet，kubeadm本身套件沒有包刮kubelet及kubectl，所以這三個都要安裝在三台VM上"></a>2. 在三台VM安裝kubeadm、kubectl及kubelet，kubeadm本身套件沒有包刮kubelet及kubectl，所以這三個都要安裝在三台VM上</h2><ul>
<li>這部分直接參照複製貼上就好<br><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span><br><span class="line">cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb https://apt.kubernetes.io/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubelet kubeadm kubectl</span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="3-在Master-VM上初始化，因為在建k8s的時候，彼此物件之間的網路沒有所謂的linux-bridge已經建好，必須使用目前各自hypervisor提供的POD-network或是可以稱為Cluster-network"><a href="#3-在Master-VM上初始化，因為在建k8s的時候，彼此物件之間的網路沒有所謂的linux-bridge已經建好，必須使用目前各自hypervisor提供的POD-network或是可以稱為Cluster-network" class="headerlink" title="3. 在Master VM上初始化，因為在建k8s的時候，彼此物件之間的網路沒有所謂的linux bridge已經建好，必須使用目前各自hypervisor提供的POD network或是可以稱為Cluster network"></a>3. 在Master VM上初始化，因為在建k8s的時候，彼此物件之間的網路沒有所謂的linux bridge已經建好，必須使用目前各自hypervisor提供的POD network或是可以稱為Cluster network</h2><ul>
<li><p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a></p>
</li>
<li><p>這邊要特別注意在初始化的過程中要指定要用什麼cluster network，通常會跟你用什麼hypervisor有關係，如果用virtualbox就用flanner，此外因為現在有兩張介面卡，所以要在Master VM上指定node彼此之間用的ip，就是步驟1給Master VM的ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=&lt;ip-address&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>安裝完後將Master VM上顯示的指令key上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#mkdir...</span><br><span class="line">#...</span><br><span class="line">#...</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="4-建立Master-VM的網路-如果步驟3選擇flannel的話"><a href="#4-建立Master-VM的網路-如果步驟3選擇flannel的話" class="headerlink" title="4. 建立Master VM的網路 (如果步驟3選擇flannel的話)"></a>4. 建立Master VM的網路 (如果步驟3選擇flannel的話)</h2>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/62e44c867a2846fefb68bd5f178daf4da3095ccb/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>   這邊要等一段時間，等network建好才進行步驟5</p>
<h2 id="5-兩台Worker-node的VM加入Master這個cluster"><a href="#5-兩台Worker-node的VM加入Master這個cluster" class="headerlink" title="5. 兩台Worker node的VM加入Master這個cluster"></a>5. 兩台Worker node的VM加入Master這個cluster</h2><ul>
<li>兩台Worker VM上key上在步驟3 Master node最後產生的kubeadm join的指令，用來加入Master的VM</li>
<li>可以在Master VM上打kubectl get pods指令來看兩個Worker VM有沒有Ready</li>
<li>如果有的話即安裝完成</li>
</ul>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2019 <a href="/" rel="nofollow">John Doe</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>