<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Helm/chart in kubernetes | 網路技術學習過程</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">網路技術學習過程</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Helm/chart in kubernetes</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2019-09-06</div><div class="post-tags"><a class="post-tag-link" href="/tags/Helm/">Helm</a>/<a class="post-tag-link" href="/tags/chart/">chart</a>/<a class="post-tag-link" href="/tags/kubernetes/">kubernetes</a></div></div></div><article><div class="container post"><p>摘要自</p>
<ol>
<li><a href="https://godleon.github.io/blog/Kubernetes/k8s-Helm-Introduction/" target="_blank" rel="noopener">https://godleon.github.io/blog/Kubernetes/k8s-Helm-Introduction/</a></li>
<li><a href="https://www.inwinstack.com/2017/06/15/the-kubernetes-package-manager-helm/" target="_blank" rel="noopener">https://www.inwinstack.com/2017/06/15/the-kubernetes-package-manager-helm/</a></li>
</ol>
<h1 id="Helm-is-a-tool-for-managing-Kubernetes-charts-Charts-are-packages-of-pre-configured-Kubernetes-resources"><a href="#Helm-is-a-tool-for-managing-Kubernetes-charts-Charts-are-packages-of-pre-configured-Kubernetes-resources" class="headerlink" title="Helm is a tool for managing Kubernetes charts. Charts are packages of pre-configured Kubernetes resources."></a>Helm is a tool for managing Kubernetes charts. Charts are packages of pre-configured Kubernetes resources.</h1><p>簡單來說就是可以將一個 or 多個應用包裝成一個服務，並透過 chart 的形式發佈，讓大家可以方便在 k8s 上安裝特定的服務。</p>
<p>幾個元件的名詞</p>
<ol>
<li>Tiller server: 用來與API server溝通，使用chart在k8s cluster上建立服務</li>
<li>Helm client: 則是用來操作Tiller server</li>
<li>Chart: 一堆 k8s resource object definition 的集合，目的就是要在 k8s 上佈署多個不同的 resource object；而為了要重複利用，這些 resource object definition 必須要支援 template, parameter … 等相關功能。</li>
<li>Repo: 用來儲存chart file，由Helm client管理</li>
<li>Release: Release 則是由 chart 產生的一個個 instance，一個 chart 可以被佈署多次，每一個佈署都是每個獨立的 instance，在 Helm 中則稱為 Release，每個 release name 都不同且獨立運作的</li>
</ol>
<p>佈署Helm時可以將其佈署在cluster level(整個k8s cluster皆可用)，也可以佈署在namespace level<br>當初K8s為了解決micro service的問題，提供了大量的resource object (pod, deployment, service…etc)，因此如何利用這些resource object來組成一個完整的系統，整個過程是很複雜的。</p>
<ul>
<li>如何管理、編輯&amp;更新大量的k8s resources object設定檔?</li>
<li>如何快速佈署一個含有很多設定檔的k8s application?</li>
<li>如何分享 &amp; 重複利用k8s resource object設定檔?</li>
<li>如何透過parameter &amp; template的方式，使用相同的設定檔來支援不同環境上的佈署</li>
<li>如何管理application的deployment, rollback, diff &amp; history?</li>
<li>application發布後如何進行驗證</li>
</ul>
<p>Helm 就是為了解決上述問題而被開發出來的工具</p>
<ul>
<li>將 k8s resource object 打包到一個 chart 中 (chart 是多個 k8s resource object configuration 的集合)</li>
<li>將 chart 保存在 chart repository 中，透過 repository 的方式來儲存 &amp; 分享 chart</li>
<li>Helm 則利用 chart 來進行 deployment, upgrade, rollback, version control …. 等工作</li>
</ul>
<h2 id="install-helm-client"><a href="#install-helm-client" class="headerlink" title="install helm client"></a>install helm client</h2><p>載筆電適合的bin檔</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://storage.googleapis.com/kubernetes-helm/helm-$(curl -s https://api.github.com/repos/helm/helm/releases/latest | jq --raw-output &apos;.tag_name&apos;)-linux-amd64.tar.gz -O helm-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">$ tar -zxvf helm-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">$ sudo mv linux-amd64/helm /usr/local/bin/helm</span><br></pre></td></tr></table></figure>

<h2 id="將Helm佈署至cluster-level"><a href="#將Helm佈署至cluster-level" class="headerlink" title="將Helm佈署至cluster level"></a>將Helm佈署至cluster level</h2><p>不一定要做，除非要改變原來的context</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 設定 default context</span><br><span class="line">$ kubectl config use-context admin-cluster.local</span><br><span class="line">Switched to context &quot;admin-cluster.local&quot;.</span><br></pre></td></tr></table></figure>

<h2 id="為Tiller-server開啟權限"><a href="#為Tiller-server開啟權限" class="headerlink" title="為Tiller server開啟權限"></a>為Tiller server開啟權限</h2><p>tiller 就是一個用來與 k8s API server 溝通的 service，因此我們要賦予 tiller 所需要的權限</p>
<ol>
<li>在 kube-system namespace 中建立 Service Account tiller</li>
<li>建立 ClusterRoleBinding，將 Service Account tiller 與 Cluster Role cluster-admin 作繫結</li>
</ol>
<p>rbac-config.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 建立 Service Account &quot;tiller&quot; 給 Helm service 與 API server 認證之用</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line"># 建立 ClusterRoleBinding，將 Role &quot;cluser-admin&quot; 權限賦予 Service Account &quot;tiller&quot; </span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: tiller</span><br><span class="line">    namespace: kube-system</span><br></pre></td></tr></table></figure>

<p>設定檔套用到k8s中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f rbac-config.yaml</span><br></pre></td></tr></table></figure>

<p>最後進行Helm的初始化:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm init –service-account tiller</span><br></pre></td></tr></table></figure>

<h2 id="更新Helm-Repo"><a href="#更新Helm-Repo" class="headerlink" title="更新Helm Repo"></a>更新Helm Repo</h2><p>更新Helm repository, Helm client會取得所有Stable的charts</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 取得最新的 chart 資訊</span><br><span class="line">$ helm repo update</span><br><span class="line">Hang tight while we grab the latest from your chart repositories...</span><br><span class="line">...Skip local chart repository</span><br><span class="line">...Successfully got an update from the &quot;stable&quot; chart repository</span><br><span class="line">Update Complete. ⎈ Happy Helming!⎈ </span><br><span class="line"></span><br><span class="line"># 搜尋 helm charts (會出現很多 charts info)</span><br><span class="line">$ helm search -l</span><br><span class="line">.... (略)</span><br></pre></td></tr></table></figure>

<h2 id="安裝第一個Helm-chart"><a href="#安裝第一個Helm-chart" class="headerlink" title="安裝第一個Helm chart"></a>安裝第一個Helm chart</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># 搜尋 mysql 相關的 Helm chart</span><br><span class="line">$ helm search mysql</span><br><span class="line">NAME                            	CHART VERSION	APP VERSION	DESCRIPTION                                                 </span><br><span class="line">stable/mysql                    	0.11.0       	5.7.14     	Fast, reliable, scalable, and easy to use open-source rel...</span><br><span class="line">.... (略)</span><br><span class="line"></span><br><span class="line"># 安裝 mysql helm chart</span><br><span class="line">$ helm install stable/mysql</span><br><span class="line">NAME:   wayfaring-butterfly</span><br><span class="line">LAST DEPLOYED: Sat Dec 22 07:34:54 2018</span><br><span class="line">NAMESPACE: helm-lab</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Secret</span><br><span class="line">NAME                       TYPE    DATA  AGE</span><br><span class="line">wayfaring-butterfly-mysql  Opaque  2     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                            DATA  AGE</span><br><span class="line">wayfaring-butterfly-mysql-test  1     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/PersistentVolumeClaim</span><br><span class="line">NAME                       STATUS   VOLUME  CAPACITY  ACCESS MODES  STORAGECLASS  AGE</span><br><span class="line">wayfaring-butterfly-mysql  Pending  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                       TYPE       CLUSTER-IP    EXTERNAL-IP  PORT(S)   AGE</span><br><span class="line">wayfaring-butterfly-mysql  ClusterIP  10.233.22.63  &lt;none&gt;       3306/TCP  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta1/Deployment</span><br><span class="line">NAME                       DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">wayfaring-butterfly-mysql  1        1        1           0          0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                                       READY  STATUS   RESTARTS  AGE</span><br><span class="line">wayfaring-butterfly-mysql-6bbdd45dc-jdsn6  0/1    Pending  0         0s</span><br><span class="line">.... (略)</span><br><span class="line"></span><br><span class="line"># 列出已經安裝的 Helm chart</span><br><span class="line">$ helm ls</span><br><span class="line">NAME               	REVISION	UPDATED                 	STATUS  	CHART       	APP VERSION	NAMESPACE</span><br><span class="line">wayfaring-butterfly	1       	Sat Dec 22 07:34:54 2018	DEPLOYED	mysql-0.11.0	5.7.14     	helm-lab</span><br><span class="line"></span><br><span class="line"># 檢視目前的 resource object</span><br><span class="line">$ kubectl get all</span><br><span class="line">NAME                                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/wayfaring-butterfly-mysql-6bbdd45dc-jdsn6   0/1     Pending   0          5m51s</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/wayfaring-butterfly-mysql   ClusterIP   10.233.22.63   &lt;none&gt;        3306/TCP   5m51s</span><br><span class="line"></span><br><span class="line">NAME                                        DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/wayfaring-butterfly-mysql   1         1         1            0           5m51s</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/wayfaring-butterfly-mysql-6bbdd45dc   1         1         0       5m51s</span><br></pre></td></tr></table></figure>

<p>helm chart 的每一個佈署，都被稱為一個 release，因此可以用同樣的 helm chart 安裝多個 release，從上面可以看到，在沒有指定 release name 的情況下，helm client 會自動幫你產生一個</p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2019 <a href="/" rel="nofollow">John Doe</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>